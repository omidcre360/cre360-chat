app.get("/console", (_req, res) => {
  const API = process.env.RENDER_EXTERNAL_URL || "https://cre360-signal-api.onrender.com";
  const html = [
    "<!doctype html>",
    "<html><head><meta charset='utf-8'/>",
    "<meta name='viewport' content='width=device-width, initial-scale=1'>",
    "<title>CRE360 Signal Console</title>",
    "<style>",
    ":root{--bg:#0B0B0B;--text:#FFFFFF;--gold:#BFA77A;--accent:#D9CBA2;--muted:rgba(255,255,255,.72);--line:rgba(255,255,255,.10)}",
    "html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,Arial,sans-serif}",
    ".panel{position:relative;display:flex;flex-direction:column;width:100%;height:100vh;border-radius:16px;overflow:hidden;box-shadow:0 20px 50px rgba(0,0,0,.35)}",
    /* subtle animated texture (kept simple/ASCII) */
    ".panel:before{content:'';position:absolute;inset:0;pointer-events:none;mix-blend-mode:overlay;opacity:.18;",
    "background:radial-gradient(900px 500px at 120% 120%, rgba(191,167,122,.10), transparent 55%);",
    "animation:drift 14s ease-in-out infinite alternate}",
    "@keyframes drift{0%{transform:translate3d(0,0,0)}100%{transform:translate3d(-2%,-3%,0)}}",
    ".head{position:relative;z-index:1;display:flex;align-items:center;justify-content:space-between;padding:14px 16px;",
    "border-bottom:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02))}",
    ".brandL{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px}.dot{color:var(--gold)}.title{font-size:16px}",
    ".powered{font-size:12px;color:var(--muted)}.powered b{color:var(--gold)}",
    ".sub{padding:8px 16px 10px;font-size:13px;color:var(--muted)}",
    ".chipbar{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px;padding:0 16px 12px}",
    ".chip{border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);border-radius:999px;padding:8px 10px;font-size:12px;cursor:pointer;text-align:center}",
    "@media (max-width:1024px){.chipbar{grid-template-columns:1fr}}",
    ".messages{position:relative;z-index:1;flex:1;overflow:auto;padding:10px 16px 16px;display:flex;flex-direction:column;gap:10px}",
    ".bub{padding:12px 14px;border-radius:12px;max-width:92%;line-height:1.35;font-size:14px;white-space:pre-wrap}",
    ".user{background:rgba(255,255,255,.10);align-self:flex-end}.bot{background:rgba(255,255,255,.06);border:1px solid var(--line)}",
    ".input{display:flex;gap:8px;padding:12px;border-top:1px solid var(--line);background:rgba(255,255,255,.02)}",
    ".field{flex:1;background:rgba(255,255,255,.10);border:1px solid var(--line);color:var(--text);border-radius:10px;padding:11px 12px;font-size:14px}",
    ".send{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;background:var(--gold);color:#111;font-weight:800}",
    ".foot{padding:6px 12px;font-size:11px;text-align:center;color:var(--muted);border-top:1px solid var(--line)}",
    "</style></head><body>",
    "<div class='panel'>",
    "<div class='head'><div class='brandL'><span class='dot'>&#9679;</span><span class='title'>CRE360 Signal&#8482;</span></div>",
    "<div class='powered'>Powered by <b>ChatGPT + CRE360.ai</b></div></div>",
    "<div class='sub'>Operator-grade market intelligence — ask sharper questions.</div>",
    "<div id='chips' class='chipbar'></div>",
    "<div id='msgs' class='messages'></div>",
    "<div class='input'><input id='field' class='field' placeholder='Ask the Signal...'><button id='send' class='send'>Send</button></div>",
    "<div class='foot'>&#169; CRE360 — Institutional, decisive, no fluff.</div>",
    "</div>",
    "<script>",
    "(function(){",
    "var API='" + API + "';",
    "var msgs=document.getElementById('msgs'), field=document.getElementById('field'), send=document.getElementById('send'), chips=document.getElementById('chips');",
    "var starters=[",
    " {label:'Today\\'s Signal', text:'Give me today\\'s CRE360 Signal in 3 bullets.'},",
    " {label:'Underwriting', text:'Pressure-test my extended-stay underwriting.'},",
    " {label:'Extended-Stay', text:'Why are extended-stay hotels outperforming in 2025?'},",
    " {label:'Risk Check', text:'List the top 3 execution risks on a new hotel development.'}",
    "];",
    "starters.forEach(function(s){ var b=document.createElement('button'); b.className='chip'; b.textContent=s.label; b.onclick=function(){ field.value=s.text; field.focus(); }; chips.appendChild(b); });",
    "function bub(t,who){ var d=document.createElement('div'); d.className='bub '+who; d.textContent=t; msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight; return d; }",
    "async function ask(q){ if(!q) return; bub(q,'user'); field.value=''; var bot=bub('…','bot');",
    " try{ var r=await fetch(API+'/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({message:q})});",
    " if(!r.body){ bot.textContent='(service error)'; return; } var rd=r.body.getReader(), dec=new TextDecoder(); bot.textContent='';",
    " while(true){ var x=await rd.read(); if(x.done) break; bot.textContent+=dec.decode(x.value,{stream:true}); msgs.scrollTop=msgs.scrollHeight; }",
    " }catch(e){ bot.textContent='(network error)'; } }",
    "send.onclick=function(){ ask(field.value.trim()); };",
    "field.onkeydown=function(e){ if(e.key==='Enter') ask(field.value.trim()); };",
    "bub('Here\\'s the deal — ask about underwriting, extended-stay, or today\\'s Signal.','bot');",
    "})();",
    "</script>",
    "</body></html>"
  ].join("");
  res.send(html);
});
